# 详解TCP

可靠数据传输协议，解决不可靠信道的可靠传输问题。

首先假设两个进程A和B已经建立连接。

## 首部字段和数据字段

TCP报文段由首部字段和数据字段组成。

数据字段就是委托给TCP通信对象发送的内容。

首部字段帮助TCP通信对象处理TCP报文。

## 序号和确认号

首部字段包括两个最重要的字段：序号和确认号。

序号表示该报文段的第一个字节在整个流当中的位置

确认号表示希望收到的下一个序号，也即表示该序号之前的报文都收到了，这种机制叫做**累积确认**。

我们在解释这些概念的时候会有发送方和接收方，实际上，通信实体可以同时是发送方和接收方，但是对于某一条通讯报文来说，必定有发送方和接收方。



发送方利用收到的确认号判断哪些报文已经被接收，从而使得发送窗口前移。

实际上就是让发送窗口前移到确认号的位置。

接收方每收到一个报文，首先尝试接收报文，如果在窗口内且没有接收过则缓存，然后尝试上传，如果希望接收到的下一个序号已经接收到了，那么窗口前移的同时上传报文给应用层。最后发送确认号，确认号就是窗口的左边界。

整理一下：

- 尝试接收报文
- 尝试上传
- 发送确认号

只有发送确认号是一定要做的。

只要报文在窗口内就接收，无论是不是希望收到的下一个序号。

如果收到失序报文，会发送冗余的确认号，而不是该报文的下一个序号，因为确认号表示“该号码之前的所有报文都收到了”，而失序报文之前仍然有报文没有收到，所以只能重复发送。

如果收到按序报文，窗口可能前移一个报文的位置，也可能前移很多报文的位置，原因是可能有失序的报文已经被缓存。



## 超时重传

要保证可靠传输，但是信道可能出现丢包，发送方为了保证每个报文最终一定到达，根据收到的ACK判断哪些报文已经全部送达。如果报文超过了一定时间还没有收到ACK，说明很有可能丢包了，这时发送方会重新发送这个包。

### 多长时间算超时

超时的时间应该比实际往返时间（RTT）大一点。

- $SampleRTT$，随机取样，每隔一段时间测试某个包的往返时间
- $EstimatedRTT=（1-\alpha）\cdot EstimatedRTT + \alpha\cdot SampleRTT$

- $DevRTT = (1-\beta)\cdot DevRTT + \beta\cdot |SampleRTT - EstimatedRTT|$描述样本值偏离估计值的程度

- $TimeoutInterrval = EstimatedRTT + 4\cdot DevRTT$，使用这个作为重传超时间隔

### 发送方事件处理

- 收到上层数据
  - 生成报文段
  - 如果定时器没有运行，启动定时器
  - 向IP传递报文段
- 定时器超时
  - 重传最小序号未应答报文
  - 超时间隔加倍
  - 启动定时器
- 收到ACK
  - 如果确认号大于当前窗口基序号
    - 窗口前移至ACK
    - 如果当前没有任何应答报文段
      - 启动定时器
  - 如果连续三次收到同一个ACK，启动快速重传

### 接收方事件处理

- 收到报文
  - 尝试缓存
  - 尝试上传
  - 尝试移动窗口
  - 发送确认号，如果刚好有要发送的消息可以用**捎带确认**

### 流量控制

使得发送方和接收方速率同步的机制。

**接收窗口**根据接收方的剩余缓存空间实时调整，相应包中存放了剩余缓冲空间，也就是窗口大小字段。

所有的发送数据都必须在**接收窗口rwnd**内

### tcp连接管理

#### 三次握手

- 客户端：SYN=1，ACK=0，提供初始序列号client_isn
- 服务端：SYN=1，ACK=1,ack = client_isn+1，提供初始序列号server_isn;
- 客户端:  SYN = 0,  ACK = 1,ack = server_isn+1,这个包可以带数据，前两个包一定不带数据

#### 四次挥手

- 客户端：FIN=1
- 服务端：ACK=1
- 服务端：FIN=1
- 客户端：ACK=1

如果服务端选择立即关闭，第二次和第三次可以合并

### 拥塞控制原理

#### TCP发送方如何限制向其连接发送流量

通过维护**拥塞窗口cwnd**

在发送方中未被确认的数据量不会超过cwnd与rwnd中的最小值

#### TCP发送方如何感知它与目的地之间的路径上出现拥塞

- 丢失报文意味着拥塞
- 确认报文意味着不拥塞
- 带宽探测，丢失报文就减速，收到确认报文就加速

#### TCP拥塞控制算法

##### 慢启动

- 初始cwnd设置为一个MSS，每收到一个确认报文，就将拥塞窗口增加一个MSS，所以cwnd会以指数形式增长
- 如果出现超时，将cwnd设置为1，重新开始慢启动，并且将ssthresh（慢启动阈值）设置为cwnd/2
- 当cwnd的值等于ssthresh时，结束慢启动，进入拥塞避免模式
- 当检测到三个冗余ACK，执行快速重传，cwnd的值减半，ssthresh的值记录为cwnd的值的一半，进入快速恢复状态

##### 拥塞避免

- 每个RTT将cwnd增加一个MSS，线性增长
- 如果出现超时，将cwnd设置为1，重新开始慢启动，并且将ssthresh（慢启动阈值）设置为cwnd/2
- 当检测到三个冗余ACK，执行快速重传，进入快速恢复状态

##### 快速恢复

- 每收到一个冗余ACK，cwnd的值增加一个MSS，收到丢失的ACK时，TCP在降低cwnd后进入拥塞避免状态

